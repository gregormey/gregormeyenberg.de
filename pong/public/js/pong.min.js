/*! Copyright 2014, Gregor Meyenberg pong 2014-05-29 */
var PLAYER_LEFT=0,PLAYER_RIGHT=1,PLAYER_MOVEUP=0,PLAYER_MOVEDOWN=1,Player=function(a,b){this.y=15,this.width=10,this.height=40,this.speed=1,this.direct=0,this.side=b?b:PLAYER_LEFT,this.bounding=2,this.score=0,this.ctx=a,this.side==PLAYER_LEFT?this.x=5:this.side==PLAYER_RIGHT&&(this.x=this.ctx.width-(this.width+5)),this.addScore=function(){this.score++,$("#"+this.ctxReference+"Score").html(this.score),this.ctx.ball.reset(this.side)},this.getHitPoint=function(){return this.side==PLAYER_LEFT?this.ctx.ball.x-this.ctx.ball.radius<this.x+this.width+this.bounding:this.side==PLAYER_RIGHT?this.ctx.ball.x+this.ctx.ball.radius>this.x-this.bounding:void 0},this.hit=function(){return this.getHitPoint()&&this.ctx.ball.y-this.ctx.ball.radius>this.y-10&&this.ctx.ball.y+this.ctx.ball.radius<this.y+this.height+10?-(this.y+this.height/2-this.ctx.ball.y)/10:!1},this.draw=function(){this.beforeDraw&&this.beforeDraw(),h=this.ctx.height;var a=this.speed*this.direct;this.y+a<h-this.height&&this.y+a>0&&(this.y+=a),this.speed+=this.speedInc?this.speedInc:0,this.ctx.fillRect(this.x,this.y,this.width,this.height)},this.move=function(a){a==PLAYER_MOVEUP?this.direct=-1:a==PLAYER_MOVEDOWN&&(this.direct=1)},this.stop=function(){this.interval=!1,this.speed=1,this.direct=0},this.init&&this.init()};"undefined"!=typeof module&&(module.exports=Player);var Ball=function(a){this.incY=0,this.speed=1,this.move=!1,this.radius=5,this.ctx=a,this.reset=function(b){this.x=a.width/2,this.y=a.height/2,this.incX=b==PLAYER_RIGHT?-2:2,this.incY=0},this.reset(PLAYER_RIGHT),this.draw=function(){this.ctx.beginPath(),this.ctx.arc(this.x,this.y,this.radius,0,2*Math.PI,!0),this.ctx.fill(),this.move()},this.getEdgeHitValue=function(a,b,c,d){return a+c>b-d||d>a+c?-1*c:c},this.setPlayerHit=function(a,b,c){(a||b)&&(this.incX=-1*c,this.incY=a?a:b,this.x+=this.incX,this.y+=this.incY)},this.checkScore=function(a){this.x<0?this.ctx.opponent.addScore():this.x>a&&this.ctx.player.addScore()},this.move=function(){h=a.height,w=a.width,this.incY=this.getEdgeHitValue(this.y,h,this.incY,this.radius),this.x+=this.incX,this.y+=this.incY,this.setPlayerHit(this.ctx.player.hit(),this.ctx.opponent.hit(),this.incX),this.checkScore(w)}};"undefined"!=typeof module&&(module.exports=Ball);var ComputerPlayer=function(a,b){this.ctxReference="opponent",this.moveDown=!1,this.moveUp=!1,this.beforeDraw=function(){var a=this.y+this.height/2;this.ctx.ball.y<a?a-this.ctx.ball.y>5?(this.moveUp=!0,this.moveDown=!1,this.move(PLAYER_MOVEUP)):this.stop():this.ctx.ball.y>a?this.ctx.ball.y-a>5?(this.moveUp=!1,this.moveDown=!0,this.move(PLAYER_MOVEDOWN)):this.stop():this.stop()},this.speedInc=.01,Player.call(this,a,b)};"undefined"!=typeof module&&(module.exports=ComputerPlayer);var HumanPlayer=function(a,b){this.ctxReference="player",this.speedInc=.01,this.init=function(){$(document).keydown($.proxy(function(a){38==a.keyCode?this.move(PLAYER_MOVEUP):40==a.keyCode&&this.move(PLAYER_MOVEDOWN)},this)),$(document).keyup($.proxy(function(){this.stop()},this))},Player.call(this,a,b)};"undefined"!=typeof module&&(module.exports=HumanPlayer);var YagsClient=function(a){if(!("WebSocket"in window))return void alert("Websockets are not supported");this.opponentsListChange=function(a){var b=opponentsList.render({players:a});$("tbody").html(b)};var b="ws://localhost:"+a+"/websocket";this.websocket=new WebSocket(b),this.websocket.onopen=function(){},this.websocket.onclose=function(){location.href="/logout"},this.websocket.onmessage=$.proxy(function(a){var b=JSON.parse(a.data);if(!this[b.event])throw"Event "+b.event+" not supported";this[b.event](b.data)},this),this.websocket.onerror=function(){}};!function(a){a.fn.pong=function(b){b=a.extend({},a.fn.pong.defaults,b);var c=[],d=function(){a.fn.pong.ctx.forEach(function(a){a.clearRect(0,0,a.width,a.height)}),c.forEach(function(a){a.draw()})};return window.setInterval(d,1e3/b.fps),this.each(function(){$me=a(this);var b=this,d=b.getContext("2d");d.width=$me.innerWidth(),d.height=$me.innerHeight(),a.fn.pong.ctx.push(d),d.fillStyle=$me.css("color"),d.strokeStyle=$me.css("color"),d.ball=new Ball(d),d.player=new HumanPlayer(d,PLAYER_LEFT),d.opponent=new ComputerPlayer(d,PLAYER_RIGHT),c.push(d.ball),c.push(d.player),c.push(d.opponent)})},a.fn.pong.defaults={fps:100},a.fn.pong.ctx=[]}(jQuery);