/*! Copyright 2014, Gregor Meyenberg pong 2014-06-12 */
var PLAYER_LEFT=0,PLAYER_RIGHT=1,PLAYER_MOVEUP=0,PLAYER_MOVEDOWN=1,Player=function(a,b){this.y=15,this.width=10,this.height=40,this.speed=1,this.direct=0,this.side=b?b:PLAYER_LEFT,this.bounding=2,this.score=0,this.ctx=a,this.side==PLAYER_LEFT?(this.x=5,this.hasBall=!0):this.side==PLAYER_RIGHT&&(this.x=this.ctx.width-(this.width+5),this.hasBall=!1),this.addScore=function(){this.score++,$("#"+this.ctxReference+"Score").html(this.score),this.hasBall=!0,this.ctx.ball.reset()},this.getHitPoint=function(){return this.side==PLAYER_LEFT?this.ctx.ball.x-this.ctx.ball.radius<this.x+this.width+this.bounding:this.side==PLAYER_RIGHT?this.ctx.ball.x+this.ctx.ball.radius>this.x-this.bounding:void 0},this.hit=function(){return this.getHitPoint()&&this.ctx.ball.y-this.ctx.ball.radius>this.y-10&&this.ctx.ball.y+this.ctx.ball.radius<this.y+this.height+10?-(this.y+this.height/2-this.ctx.ball.y)/10:!1},this.draw=function(){this.beforeDraw&&this.beforeDraw(),h=this.ctx.height;var a=this.speed*this.direct;this.y+a<h-this.height&&this.y+a>0&&(this.y+=a),this.speed+=this.speedInc?this.speedInc:0,this.ctx.fillRect(this.x,this.y,this.width,this.height)},this.move=function(a){a==PLAYER_MOVEUP?this.direct=-1:a==PLAYER_MOVEDOWN&&(this.direct=1)},this.stop=function(){this.interval=!1,this.speed=1,this.direct=0},this.init&&this.init()};"undefined"!=typeof module&&(module.exports=Player);var Ball=function(a){this.incY=0,this.speed=1,this.move=!1,this.radius=5,this.ctx=a,this.getHasBall=function(){var a=null;return this.ctx.opponent.hasBall?a=this.ctx.opponent:this.ctx.player.hasBall&&(a=this.ctx.player),a},this.reset=function(){var a=this.getHasBall();null!=a&&(a.side==PLAYER_RIGHT?(this.incX=-2,this.x=a.x):(this.incX=2,this.x=a.x+this.ctx.opponent.width),this.y=a.y+this.ctx.opponent.height/2,this.incX=a.side==PLAYER_RIGHT?-2:2,this.incY=0)},this.reset(),this.release=function(){var a=this.getHasBall();a.hasBall=!1,a.side==PLAYER_RIGHT?this.x-=a.width:this.x+=a.width},this.draw=function(){this.ctx.opponent.hasBall?this.y=this.ctx.opponent.y+this.ctx.opponent.height/2:this.ctx.player.hasBall&&(this.y=this.ctx.player.y+this.ctx.player.height/2),this.ctx.beginPath(),this.ctx.arc(this.x,this.y,this.radius,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.opponent.hasBall||this.ctx.player.hasBall||this.move()},this.getEdgeHitValue=function(a,b,c,d){return a+c>b-d||d>a+c?-1*c:c},this.setPlayerHit=function(a,b,c){(a||b)&&(this.incX=-1*c,this.incY=a?a:b,this.x+=this.incX,this.y+=this.incY)},this.checkScore=function(a){this.x<0?this.ctx.opponent.addScore():this.x>a&&this.ctx.player.addScore()},this.move=function(){h=a.height,w=a.width,this.incY=this.getEdgeHitValue(this.y,h,this.incY,this.radius),this.x+=this.incX,this.y+=this.incY,this.setPlayerHit(this.ctx.player.hit(),this.ctx.opponent.hit(),this.incX),this.checkScore(w)}};"undefined"!=typeof module&&(module.exports=Ball);var ComputerPlayer=function(a,b){this.ctxReference="opponent",this.moveDown=!1,this.moveUp=!1,this.releaseBall=!1,this.beforeDraw=function(){var a=this.y+this.height/2,b=this.ctx.ball;this.hasBall&&window.setTimeout(function(){b.release()},2e3),this.ctx.ball.y<a?a-this.ctx.ball.y>5?(this.moveUp=!0,this.moveDown=!1,this.move(PLAYER_MOVEUP)):this.stop():this.ctx.ball.y>a?this.ctx.ball.y-a>5?(this.moveUp=!1,this.moveDown=!0,this.move(PLAYER_MOVEDOWN)):this.stop():this.stop()},this.speedInc=.01,Player.call(this,a,b)};"undefined"!=typeof module&&(module.exports=ComputerPlayer);var HumanPlayer=function(a,b,c){this.ctxReference="player",this.opponent=c,this.speedInc=.01,this.init=function(){$(document).keydown($.proxy(function(a){38==a.keyCode?this.move(PLAYER_MOVEUP):40==a.keyCode?this.move(PLAYER_MOVEDOWN):32==a.keyCode&&this.ctx.ball.release(),YagsClient&&YagsClient.sendObjectsToRemote(this.direct)},this)),$(document).keyup($.proxy(function(){this.stop(),YagsClient&&YagsClient.sendObjectsToRemote(this.direct)},this))},Player.call(this,a,b)};"undefined"!=typeof module&&(module.exports=HumanPlayer);var RemotePlayer=function(a,b){this.ctxReference="opponent",this.speedInc=.01,this.setRemoteData=function(a){0==a?this.stop():1==a?this.move(PLAYER_MOVEDOWN):-1==a&&this.move(PLAYER_MOVEUP)},Player.call(this,a,b)};"undefined"!=typeof module&&(module.exports=RemotePlayer);var YagsClient={websocket:null,opponent:null,user:null,init:function(a,b,c,d){if(!("WebSocket"in window))return void alert("Websockets are not supported");this.opponent=c,this.user=b;var e="ws://localhost:"+a+"/websocket";this.websocket=new WebSocket(e),this.websocket.onopen=function(){console.log("register HASH:"+YagsClient.user),YagsClient.websocket.send(JSON.stringify({RegisterHash:YagsClient.user})),d&&YagsClient[d]()},this.websocket.onclose=function(){location.href="/logout"},this.websocket.onmessage=function(a){var b=JSON.parse(a.data);if(!YagsClient[b.event])throw"Event "+b.event+" not supported";YagsClient[b.event](b.data)},this.websocket.onerror=function(){}},opponentsListChange:function(a){if(opponentsList){a=$.map(a,function(a){return a.Hash==YagsClient.user?null:a});var b=opponentsList.render({players:a,userHash:YagsClient.user});$("tbody").html(b)}},requestRemoteObjects:function(a){console.log("get:"+a),$.fn.pong.ctx.forEach(function(b){b.opponent.setRemoteData(a)})},startGame:function(a){location.href="/play?opponent="+a},refuseGame:function(a){location.href="/opponents?refused="+a},challangePlayer:function(a){location.href="/challange?opponent="+a},sendObjectsToRemote:function(a){console.log("send:"+a),this.opponent&&this.websocket.readyState==this.websocket.OPEN&&this.websocket.send(JSON.stringify({To:YagsClient.opponent,Data:{event:"requestRemoteObjects",data:a}}))},sendStartGame:function(){this.opponent&&this.websocket.readyState==this.websocket.OPEN&&(console.log("Start Game with:"+YagsClient.opponent),this.websocket.send(JSON.stringify({To:YagsClient.opponent,Data:{event:"startGame",data:YagsClient.user}})))},sendRefuseGame:function(){this.opponent&&this.websocket.readyState==this.websocket.OPEN&&(console.log("Refuse Game with:"+YagsClient.opponent),this.websocket.send(JSON.stringify({To:YagsClient.opponent,Data:{event:"refuseGame",data:YagsClient.user}})))},sendChallangePlayer:function(){this.opponent&&this.websocket.readyState==this.websocket.OPEN&&(console.log("Challange Player:"+YagsClient.opponent),this.websocket.send(JSON.stringify({To:YagsClient.opponent,Data:{event:"challangePlayer",data:YagsClient.user}})))}};!function(a){a.fn.pong=function(b){b=a.extend({},a.fn.pong.defaults,b);var c=[],d=function(){a.fn.pong.ctx.forEach(function(a){a.clearRect(0,0,a.width,a.height)}),c.forEach(function(a){a.draw()})};return window.setInterval(d,1e3/b.fps),this.each(function(){$me=a(this);var d=this,e=d.getContext("2d");e.width=$me.innerWidth(),e.height=$me.innerHeight(),a.fn.pong.ctx.push(e),e.fillStyle=$me.css("color"),e.strokeStyle=$me.css("color"),null!=YagsClient.opponent?(e.player=new HumanPlayer(e,b.player_side,YagsClient.opponent),e.opponent=new RemotePlayer(e,b.opponent_side)):(e.player=new HumanPlayer(e,PLAYER_LEFT),e.opponent=new ComputerPlayer(e,PLAYER_RIGHT)),e.ball=new Ball(e),c.push(e.ball),c.push(e.player),c.push(e.opponent)})},a.fn.pong.defaults={fps:100},a.fn.pong.ctx=[]}(jQuery);